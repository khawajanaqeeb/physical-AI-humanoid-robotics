"""
FastAPI application setup.

This is the main application file that configures FastAPI with CORS,
error handling, and routes.
"""

from contextlib import asynccontextmanager

from fastapi import FastAPI, Request
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import JSONResponse

from slowapi import Limiter, _rate_limit_exceeded_handler
from slowapi.util import get_remote_address
from slowapi.errors import RateLimitExceeded

from src.config.logging import configure_logging, get_logger
from src.config.settings import get_settings
from src.database import close_database
from src.clients.qdrant_client import close_qdrant_client

# Configure logging
settings = get_settings()
configure_logging(log_level=settings.log_level, json_logs=settings.json_logs)
logger = get_logger(__name__)

# Configure rate limiter
limiter = Limiter(key_func=get_remote_address, default_limits=["100/minute"])


@asynccontextmanager
async def lifespan(app: FastAPI):
    """
    Application lifespan manager.

    Handles startup and shutdown events.
    """
    # Startup
    logger.info("application_starting", version="1.0.0")

    yield

    # Shutdown
    logger.info("application_shutting_down")
    await close_database()
    await close_qdrant_client()
    logger.info("application_shutdown_complete")


# Create FastAPI application
app = FastAPI(
    title="Gemini RAG Chatbot API",
    description="Backend API for Gemini-powered RAG Chatbot using Google Generative AI",
    version="2.0.0",
    lifespan=lifespan,
)

# Add rate limiter to app state
app.state.limiter = limiter
app.add_exception_handler(RateLimitExceeded, _rate_limit_exceeded_handler)


# Configure CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.cors_origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)


# Global exception handler
@app.exception_handler(Exception)
async def global_exception_handler(request: Request, exc: Exception):
    """
    Handle uncaught exceptions.

    Logs the error and returns a 500 response.
    """
    logger.error(
        "unhandled_exception",
        error=str(exc),
        error_type=type(exc).__name__,
        path=request.url.path,
        method=request.method,
    )

    return JSONResponse(
        status_code=500,
        content={
            "error": "Internal server error",
            "error_code": "INTERNAL_ERROR",
            "details": {
                "message": str(exc) if settings.log_level == "DEBUG" else "An unexpected error occurred"
            }
        }
    )


# Root endpoint
@app.get("/")
async def root():
    """Root endpoint returning API information."""
    return {
        "name": "Gemini RAG Chatbot API",
        "version": "2.0.0",
        "description": "Backend API for Gemini-powered RAG Chatbot using Google Generative AI",
        "endpoints": {
            "health": "/health",
            "gemini_query": "/api/v1/query",
            "legacy_query": "/api/query"
        },
        "features": {
            "embedding_model": "Google Gemini embedding-001 (768 dimensions)",
            "generation_model": "Google Gemini Pro",
            "vector_database": "Qdrant Cloud",
            "metadata_database": "Neon Postgres"
        }
    }


# Import and register routes
from src.api.routes import query, health, gemini_query, test_query

# Register Gemini RAG router (v1 - primary)
app.include_router(
    gemini_query.router,
    prefix="/api/v1",
    tags=["Gemini RAG"]
)

# Register test endpoint (mock responses without API)
app.include_router(
    test_query.router,
    prefix="/api/v1",
    tags=["Testing"]
)

# Register legacy routes
app.include_router(query.router, prefix="/api", tags=["Legacy Query"])
app.include_router(health.router, tags=["Health"])

# Additional routes to be implemented:
# from api.routes import feedback, sync
# app.include_router(feedback.router, prefix="/api", tags=["feedback"])
# app.include_router(sync.router, prefix="/api/sync", tags=["sync"])


if __name__ == "__main__":
    import uvicorn

    uvicorn.run(
        "main:app",
        host="0.0.0.0",
        port=settings.api_port,
        reload=True,
        log_level=settings.log_level.lower(),
    )
