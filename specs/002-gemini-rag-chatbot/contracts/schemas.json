{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Gemini RAG Chatbot Type Definitions",
  "description": "JSON Schema definitions for data models used in the RAG chatbot system",

  "definitions": {
    "ContentChunk": {
      "type": "object",
      "description": "Represents a segmented portion of book content optimized for retrieval",
      "required": [
        "id",
        "chunk_text",
        "embedding_vector",
        "file_path",
        "source_url",
        "chunk_index",
        "total_chunks",
        "qdrant_point_id",
        "created_at",
        "updated_at"
      ],
      "properties": {
        "id": {
          "type": "string",
          "format": "uuid",
          "description": "Unique identifier for the chunk"
        },
        "chunk_text": {
          "type": "string",
          "minLength": 50,
          "maxLength": 8000,
          "description": "Actual text content (512-1024 tokens)"
        },
        "embedding_vector": {
          "type": "array",
          "items": {
            "type": "number"
          },
          "minItems": 768,
          "maxItems": 768,
          "description": "Gemini embedding representation (768 dimensions)"
        },
        "file_path": {
          "type": "string",
          "maxLength": 512,
          "pattern": "^docs/.*\\.(md|mdx)$",
          "description": "Source file path in Docusaurus"
        },
        "chapter": {
          "type": "string",
          "maxLength": 256,
          "description": "Chapter title (extracted from frontmatter)"
        },
        "section": {
          "type": "string",
          "maxLength": 256,
          "description": "Section heading within chapter"
        },
        "heading_path": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "maxItems": 5,
          "description": "Hierarchical heading path (max 5 levels)"
        },
        "source_url": {
          "type": "string",
          "format": "uri",
          "description": "Public URL to deployed book page"
        },
        "chunk_index": {
          "type": "integer",
          "minimum": 0,
          "description": "Position within parent document (zero-indexed)"
        },
        "total_chunks": {
          "type": "integer",
          "minimum": 1,
          "description": "Total chunks for parent document"
        },
        "qdrant_point_id": {
          "type": "string",
          "format": "uuid",
          "description": "Reference to Qdrant vector point"
        },
        "created_at": {
          "type": "string",
          "format": "date-time",
          "description": "Chunk creation time"
        },
        "updated_at": {
          "type": "string",
          "format": "date-time",
          "description": "Last modification time"
        }
      }
    },

    "Query": {
      "type": "object",
      "description": "Represents a user question submitted to the chatbot",
      "required": [
        "question",
        "timestamp"
      ],
      "properties": {
        "question": {
          "type": "string",
          "minLength": 3,
          "maxLength": 1000,
          "description": "User's natural language question"
        },
        "embedding_vector": {
          "type": "array",
          "items": {
            "type": "number"
          },
          "minItems": 768,
          "maxItems": 768,
          "description": "Gemini embedding of question (generated internally)"
        },
        "session_id": {
          "type": "string",
          "format": "uuid",
          "description": "Conversation session identifier"
        },
        "max_results": {
          "type": "integer",
          "minimum": 1,
          "maximum": 10,
          "default": 3,
          "description": "Number of chunks to retrieve"
        },
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "Query submission time"
        }
      }
    },

    "RetrievedContext": {
      "type": "object",
      "description": "Represents chunks retrieved from Qdrant for a specific query",
      "required": [
        "chunk",
        "similarity_score",
        "rank"
      ],
      "properties": {
        "chunk": {
          "$ref": "#/definitions/ContentChunk",
          "description": "Reference to retrieved chunk"
        },
        "similarity_score": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0,
          "description": "Cosine similarity to query"
        },
        "rank": {
          "type": "integer",
          "minimum": 1,
          "description": "Position in retrieval results (1-indexed)"
        }
      }
    },

    "SourceCitation": {
      "type": "object",
      "description": "Reference to a book section used in the response",
      "required": [
        "chapter",
        "source_url",
        "relevance_score"
      ],
      "properties": {
        "chapter": {
          "type": "string",
          "maxLength": 256,
          "description": "Chapter title"
        },
        "section": {
          "type": "string",
          "maxLength": 256,
          "description": "Section heading"
        },
        "source_url": {
          "type": "string",
          "format": "uri",
          "description": "Link to book page"
        },
        "relevance_score": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0,
          "description": "Similarity score from retrieval"
        }
      }
    },

    "Response": {
      "type": "object",
      "description": "Represents the chatbot's answer to a user query",
      "required": [
        "answer",
        "sources",
        "response_time_ms"
      ],
      "properties": {
        "answer": {
          "type": "string",
          "minLength": 10,
          "description": "Generated response text"
        },
        "sources": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/SourceCitation"
          },
          "minItems": 0,
          "maxItems": 10,
          "description": "References to book sections"
        },
        "confidence": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0,
          "description": "Response confidence score"
        },
        "response_time_ms": {
          "type": "integer",
          "minimum": 0,
          "description": "Time to generate response (milliseconds)"
        },
        "query": {
          "$ref": "#/definitions/Query",
          "description": "Associated query object"
        }
      }
    },

    "QueryResponsePair": {
      "type": "object",
      "description": "Single exchange in a conversation",
      "required": [
        "query",
        "response",
        "timestamp"
      ],
      "properties": {
        "query": {
          "$ref": "#/definitions/Query"
        },
        "response": {
          "$ref": "#/definitions/Response"
        },
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "Exchange timestamp"
        }
      }
    },

    "ConversationSession": {
      "type": "object",
      "description": "Represents a user's interaction session with the chatbot",
      "required": [
        "session_id",
        "conversation_history",
        "created_at",
        "last_activity_at",
        "is_active"
      ],
      "properties": {
        "session_id": {
          "type": "string",
          "format": "uuid",
          "description": "Unique session identifier"
        },
        "conversation_history": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/QueryResponsePair"
          },
          "maxItems": 10,
          "description": "List of query-response exchanges (max 10)"
        },
        "created_at": {
          "type": "string",
          "format": "date-time",
          "description": "Session start time"
        },
        "last_activity_at": {
          "type": "string",
          "format": "date-time",
          "description": "Last query timestamp"
        },
        "is_active": {
          "type": "boolean",
          "description": "Session active status (expires after 30 min inactivity)"
        }
      }
    },

    "ErrorResponse": {
      "type": "object",
      "description": "Standard error response format",
      "required": [
        "error",
        "message",
        "code"
      ],
      "properties": {
        "error": {
          "type": "string",
          "description": "High-level error category"
        },
        "message": {
          "type": "string",
          "description": "Human-readable error message"
        },
        "code": {
          "type": "string",
          "enum": [
            "INVALID_INPUT",
            "RATE_LIMIT_EXCEEDED",
            "EXTERNAL_SERVICE_ERROR",
            "SERVICE_DEGRADED",
            "INTERNAL_ERROR"
          ],
          "description": "Machine-readable error code"
        }
      }
    },

    "HealthResponse": {
      "type": "object",
      "description": "System health check response",
      "required": [
        "status",
        "qdrant_connected",
        "postgres_connected",
        "gemini_api_available",
        "timestamp"
      ],
      "properties": {
        "status": {
          "type": "string",
          "enum": ["healthy", "degraded", "unhealthy"],
          "description": "Overall system health status"
        },
        "qdrant_connected": {
          "type": "boolean",
          "description": "Qdrant vector database connection status"
        },
        "postgres_connected": {
          "type": "boolean",
          "description": "Neon Postgres database connection status"
        },
        "gemini_api_available": {
          "type": "boolean",
          "description": "Google Gemini API availability"
        },
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp of health check"
        }
      }
    }
  }
}
